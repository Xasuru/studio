/**
 * @file firestore.rules
 * @description Security rules for the "Mission Control" student productivity app.
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model for personal data (tasks)
 * while providing public read-only access to a global data feed (logs). The primary
 * goal is to ensure user data privacy is paramount while enabling the real-time
 * "terminal feed" feature.
 *
 * ## Data Structure
 * The data is organized into two distinct top-level collections to simplify security:
 * 1. `/users/{userId}/tasks/{taskId}`: A nested structure where all of a user's
 *    private tasks are stored directly under their unique user ID. This path-based
 *    ownership is the foundation of the security model.
 * 2. `/logs/{logId}`: A top-level collection for the global terminal feed. This
 *    data is intended for public consumption.
 *
 * ## Key Security Decisions
 * - User data is strictly segregated. A user can ONLY access documents within their
 *   own `/users/{userId}` data tree. Listing or reading other users' data is
 *   explicitly forbidden.
 * - The global `/logs` collection is publicly readable by anyone, including
 *   unauthenticated users, to power the main dashboard feed.
 * - Client-side writes to the `/logs` collection are disabled. This is a critical
 *   security measure that assumes log entries are created by a trusted server-side
 *   process (e.g., Cloud Functions) to prevent spam or malicious data entry.
 * - Writes are only permitted for authenticated users on their own documents.
 * - Schema validation is intentionally flexible to support rapid prototyping. Rules
 *   only validate conditions required for authorization, not the specific shape
 *   or data types of the documents.
 *
 * ## Denormalization for Authorization
 * The use of `/users/{userId}` as a base path is a core design choice that
 * denormalizes ownership information into the document path itself. This allows for
 * simple, fast, and cost-effective security rules (`isOwner(userId)`) that do not
 * require extra database reads (`get()`) to verify a user's identity against the
 * document they are trying to access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    /**
     * @function isSignedIn
     * @description Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @function isOwner
     * @description Checks if the currently signed-in user's ID matches the
     *              provided userId, typically from the document path.
     * @param {string} userId - The user ID to check against.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @function isExistingOwner
     * @description Ensures the document exists before checking for ownership.
     *              Crucial for preventing writes to non-existent paths on
     *              update and delete operations.
     * @param {string} userId - The user ID to check against.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description User-specific tasks. Only the owner can read or write their tasks.
     * @path /users/{userId}/tasks/{taskId}
     * @allow (create) An authenticated user creating a task in their own user space.
     *        - auth: { uid: 'user_abc' }
     *        - path: /users/user_abc/tasks/new_task_123
     * @deny  (get) A user trying to read tasks belonging to another user.
     *        - auth: { uid: 'user_xyz' }
     *        - path: /users/user_abc/tasks/some_task_456
     * @principle Restricts access to a user's own data tree (Path-based Ownership).
     */
    match /users/{userId}/tasks/{taskId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Global log entries for the terminal feed.
     * @path /logs/{logId}
     * @allow (get, list) Any user, authenticated or not, reading the logs for the feed.
     *        - auth: null OR { uid: 'any_user' }
     *        - path: /logs/log_entry_789
     * @deny  (create, update, delete) Any client attempting to write to the log.
     *        - auth: { uid: 'any_user' }
     *        - path: /logs/new_log_123
     * @principle Allows public read for UI features but locks down writes to prevent
     *            tampering, assuming logs are generated by a trusted backend.
     */
    match /logs/{logId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}
